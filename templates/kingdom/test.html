{% extends "base/base.html" %}

{% block title %}Тестовое испытание - Кадровая служба королевства{% endblock %}

{% block extra_css %}
<style>
    .question-card {
        border-left: 4px solid #667eea;
    }
    .answer-option {
        cursor: pointer;
        transition: all 0.2s;
    }
    .answer-option:hover {
        background-color: #f8f9fa;
    }
    .answer-option.selected {
        background-color: #e3f2fd;
        border-color: #2196f3;
    }
    .progress-bar {
        height: 8px;
    }
    .timer {
        font-size: 1.2rem;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2">
                    <i class="bi bi-clipboard-check me-2"></i>
                    Тестовое испытание
                </h1>
                <div class="text-muted">
                    <i class="bi bi-calendar me-1"></i>
                    {{ attempt.test.kingdom.name }}
                </div>
            </div>
        </div>
    </div>

    <!-- Прогресс -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold">Прогресс тестирования</span>
                        <span class="text-muted">
                            {{ attempt.answers.count }}/{{ attempt.total_questions }} вопросов
                        </span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" 
                             style="width: {% widthratio attempt.answers.count attempt.total_questions 100 %}%">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Текущий вопрос -->
    {% if current_question %}
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card question-card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                Вопрос {{ current_question.order }}
                            </h5>
                            <span class="badge bg-primary">
                                {{ attempt.answers.count|add:1 }}/{{ attempt.total_questions }}
                            </span>
                        </div>
                    </div>
                    <div class="card-body">
                        <h6 class="card-title mb-4">{{ current_question.text }}</h6>
                        
                        <form id="answerForm" method="post" action="{% url 'kingdom:answer_question' current_question.id %}">
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="card answer-option" data-answer="true">
                                        <div class="card-body text-center">
                                            <i class="bi bi-check-circle-fill text-success" style="font-size: 2rem;"></i>
                                            <h6 class="mt-2">Да</h6>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="card answer-option" data-answer="false">
                                        <div class="card-body text-center">
                                            <i class="bi bi-x-circle-fill text-danger" style="font-size: 2rem;"></i>
                                            <h6 class="mt-2">Нет</h6>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <input type="hidden" name="answer" id="selectedAnswer">
                            <div class="text-center">
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                                    <i class="bi bi-arrow-right me-2"></i>Ответить
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Тест завершен -->
        <div class="row">
            <div class="col-lg-6 mx-auto">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                        <h3 class="mt-3 text-success">Тестирование завершено!</h3>
                        <p class="text-muted mb-4">
                            Вы ответили на все вопросы тестового испытания.
                        </p>
                        <div class="row mb-4">
                            <div class="col-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5 class="text-primary">{{ attempt.score }}</h5>
                                        <small class="text-muted">Правильных ответов</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h5 class="text-success">{{ attempt.percentage }}%</h5>
                                        <small class="text-muted">Процент правильных</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex gap-3 justify-content-center">
                            <a href="{% url 'kingdom:test_results' attempt.id %}" class="btn btn-primary">
                                <i class="bi bi-eye me-2"></i>Посмотреть результаты
                            </a>
                            <a href="{% url 'kingdom:citizen_dashboard' %}" class="btn btn-outline-primary">
                                <i class="bi bi-house me-2"></i>Вернуться в панель
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const answerOptions = document.querySelectorAll('.answer-option');
        const selectedAnswerInput = document.getElementById('selectedAnswer');
        const submitBtn = document.getElementById('submitBtn');
        
        answerOptions.forEach(option => {
            option.addEventListener('click', function() {
                // Убираем выделение с других опций
                answerOptions.forEach(opt => opt.classList.remove('selected'));
                
                // Выделяем выбранную опцию
                this.classList.add('selected');
                
                // Устанавливаем значение ответа
                const answer = this.dataset.answer === 'true';
                selectedAnswerInput.value = answer;
                
                // Активируем кнопку отправки
                submitBtn.disabled = false;
            });
        });
        
        // Обработка отправки формы
        const answerForm = document.getElementById('answerForm');
        if (answerForm) {
            answerForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (!selectedAnswerInput.value) {
                    alert('Пожалуйста, выберите ответ');
                    return;
                }
                
                // Показываем индикатор загрузки
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Отправка...';
                submitBtn.disabled = true;
                
                // Отправляем AJAX запрос
                fetch(this.action, {
                    method: 'POST',
                    body: new FormData(this),
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.completed) {
                            // Тест завершен, перенаправляем на результаты
                            window.location.href = "{% url 'kingdom:test_results' attempt.id %}";
                        } else {
                            // Переходим к следующему вопросу
                            window.location.reload();
                        }
                    } else {
                        alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
                        submitBtn.innerHTML = '<i class="bi bi-arrow-right me-2"></i>Ответить';
                        submitBtn.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Произошла ошибка при отправке ответа');
                    submitBtn.innerHTML = '<i class="bi bi-arrow-right me-2"></i>Ответить';
                    submitBtn.disabled = false;
                });
            });
        }
    });
</script>
{% endblock %}
